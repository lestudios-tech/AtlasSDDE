<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Red de Flujo Alimentario - Colombia</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f8f9fa;
            color: #333;
            overflow: hidden;
        }

        #header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1a3a6a 100%);
            color: white;
            padding: 1.2rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #header h1 {
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        #header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        #main-container {
            display: flex;
            height: calc(100vh - 80px);
            gap: 0;
        }

        /* Panel lateral */
        #control-panel {
            width: 350px;
            background: white;
            padding: 1.5rem;
            border-right: 1px solid #e1e5e9;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        /* Contenedores principales lado a lado */
        #visualization-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #map-container, #graph-container {
            flex: 1;
            position: relative;
            border-bottom: 1px solid #e1e5e9;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #f8f9fa;
        }

        #graph {
            width: 100%;
            height: 100%;
            background: white;
            position: relative;
        }

        /* Paneles */
        .panel {
            background: white;
            border-radius: 8px;
            padding: 1.2rem;
            margin-bottom: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e1e5e9;
        }

        .panel h3 {
            color: #2c5aa0;
            margin-bottom: 0.8rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-top: 0.8rem;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 0.8rem;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #2c5aa0;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c5aa0;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.2rem;
        }

        /* Selector desplegable */
        .selector-container {
            margin-bottom: 1rem;
        }

        .municipio-select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .municipio-select:hover {
            border-color: #2c5aa0;
        }

        .municipio-select:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        /* Elementos del grafo */
        .graph-node {
            transition: all 0.3s ease;
        }

        .graph-node.highlighted {
            filter: drop-shadow(0 0 15px #2c5aa0);
            transform: scale(1.3);
            stroke: #2c5aa0;
            stroke-width: 3px;
        }

        .graph-node.connected {
            filter: drop-shadow(0 0 10px #64b5f6);
            transform: scale(1.1);
        }

        .graph-node.hidden {
            opacity: 0.2;
            transform: scale(0.8);
        }

        .graph-link {
            transition: all 0.3s ease;
        }

        .graph-link.highlighted {
            stroke-width: 8px;
            opacity: 1;
            filter: drop-shadow(0 0 6px #ff6b6b);
        }

        .graph-link.hidden {
            opacity: 0.1;
        }

        /* Marcadores del mapa */
        .city-marker {
            transition: all 0.3s ease;
        }

        .city-marker.highlighted {
            filter: drop-shadow(0 0 8px #2c5aa0);
            transform: scale(1.3);
        }

        .city-marker.connected {
            filter: drop-shadow(0 0 6px #64b5f6);
            transform: scale(1.1);
        }

        .city-marker.hidden {
            opacity: 0.3;
            transform: scale(0.7);
        }

        /* Controles */
        .section-title {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(255,255,255,0.9);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c5aa0;
            z-index: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            z-index: 500;
            display: flex;
            gap: 0.5rem;
        }

        .control-btn {
            background: white;
            border: 1px solid #e1e5e9;
            color: #2c5aa0;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-btn:hover {
            background: #2c5aa0;
            color: white;
            border-color: #2c5aa0;
        }

        /* Información de selección */
        .selection-info {
            background: #2c5aa0;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .selection-info h4 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .selection-details {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        /* Botones de acción */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .action-btn {
            padding: 0.8rem;
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            text-align: center;
            color: #333;
        }

        .action-btn:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .action-btn.primary {
            background: #2c5aa0;
            color: white;
            border-color: #2c5aa0;
        }

        .action-btn.success {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .status-indicator {
            padding: 0.5rem;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 0.8rem;
            text-align: center;
            margin: 0.5rem 0;
        }

        .status-indicator.active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-badge {
            background: #6c757d;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
        }

        .type-indicator {
            font-size: 0.7rem;
            margin-top: 0.3rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }

        .type-hub {
            background: #dc3545;
            color: white;
        }

        .type-multiple {
            background: #ffc107;
            color: #212529;
        }

        .type-single {
            background: #28a745;
            color: white;
        }

        .debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>🌾 Red de Flujo Alimentario - Colombia</h1>
        <p>Filtra la red por municipio para visualizar conexiones específicas</p>
    </div>

    <div id="main-container">
        <!-- Panel de control lateral -->
        <div id="control-panel">
            <div class="panel">
                <h3>📊 Resumen General</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-toneladas">1,295</div>
                        <div class="stat-label">Toneladas Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-conexiones">14</div>
                        <div class="stat-label">Conexiones</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-municipios">8</div>
                        <div class="stat-label">Municipios</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="flujo-promedio">92.5</div>
                        <div class="stat-label">Promedio t/ruta</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>📍 Filtro por Municipio</h3>
                <div class="status-indicator" id="filter-status">
                    Sin filtro activo - Mostrando toda la red
                </div>
                
                <div class="selector-container">
                    <select class="municipio-select" id="municipio-select" onchange="onMunicipioSelect(this.value)">
                        <option value="">-- Selecciona un municipio --</option>
                        <!-- Opciones generadas dinámicamente -->
                    </select>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn success" onclick="applyFilter()">
                        ✅ Aplicar Filtro
                    </button>
                    <button class="action-btn primary" onclick="clearFilter()">
                        🌐 Ver Red Completa
                    </button>
                </div>

                <div id="selected-info" style="margin-top: 1rem; display: none;">
                    <div style="font-size: 0.8rem; color: #666;">
                        <strong id="selected-name"></strong>
                        <div id="selected-details"></div>
                    </div>
                </div>
            </div>

            <div class="selection-info" id="selection-info" style="display: none;">
                <h4>🔍 Red Filtrada</h4>
                <div class="selection-details" id="selection-details">
                    Información del filtro aplicado
                </div>
            </div>

            <div class="panel">
                <h3>💡 Tipos de Conexión</h3>
                <div style="font-size: 0.8rem; color: #666; line-height: 1.4;">
                    <p><span class="type-indicator type-hub">Centro de red</span> 4+ conexiones</p>
                    <p><span class="type-indicator type-multiple">Múltiples conexiones</span> 2-3 conexiones</p>
                    <p><span class="type-indicator type-single">Una conexión</span> Municipios periféricos</p>
                </div>
            </div>
        </div>

        <!-- Contenedor de visualizaciones -->
        <div id="visualization-container">
            <!-- Mapa -->
            <div id="map-container">
                <div class="section-title">🗺️ Vista Geográfica</div>
                <div class="controls">
                    <button class="control-btn" onclick="fitMapToCities()">🔍 Ajustar Vista</button>
                </div>
                <div id="map"></div>
                <div class="debug-info" id="map-debug">Mapa listo</div>
            </div>

            <!-- Grafo -->
            <div id="graph-container">
                <div class="section-title">🕸️ Vista de Red</div>
                <div class="controls">
                    <button class="control-btn" onclick="simulatePhysics()">⚡ Simular Física</button>
                    <button class="control-btn" onclick="resetGraphLayout()">🔄 Reorganizar</button>
                </div>
                <div id="graph"></div>
                <div class="debug-info" id="graph-debug">Grafo listo</div>
            </div>
        </div>
    </div>

    <script>
        // Datos geoespaciales de ciudades de Colombia
        const citiesData = {
            "Bogotá": { lat: 4.7110, lng: -74.0721, region: "Andina", population: 8180000 },
            "Medellín": { lat: 6.2442, lng: -75.5812, region: "Andina", population: 2520000 },
            "Cali": { lat: 3.4516, lng: -76.5320, region: "Pacífica", population: 2240000 },
            "Barranquilla": { lat: 10.9639, lng: -74.7964, region: "Caribe", population: 1230000 },
            "Cartagena": { lat: 10.3910, lng: -75.4795, region: "Caribe", population: 914000 },
            "Bucaramanga": { lat: 7.1193, lng: -73.1227, region: "Andina", population: 581000 },
            "Cúcuta": { lat: 7.8939, lng: -72.5078, region: "Andina", population: 721000 },
            "Pereira": { lat: 4.8133, lng: -75.6961, region: "Andina", population: 467000 },
            "Manizales": { lat: 5.0703, lng: -75.5138, region: "Andina", population: 434000 },
            "Ibague": { lat: 4.4447, lng: -75.2439, region: "Andina", population: 569000 },
            "Villavicencio": { lat: 4.1420, lng: -73.6266, region: "Orinoquía", population: 531000 },
            "Santa Marta": { lat: 11.2408, lng: -74.1990, region: "Caribe", population: 515000 }
        };

        // Datos del grafo
        const graphData = {
            nodes: Object.keys(citiesData).map(city => ({
                id: city,
                ...citiesData[city],
                toneladas: Math.floor(Math.random() * 500) + 100
            })),
            links: [
                { source: "Bogotá", target: "Medellín", value: 150, type: "exportacion", product: "Café" },
                { source: "Bogotá", target: "Cali", value: 130, type: "exportacion", product: "Cereales" },
                { source: "Bogotá", target: "Barranquilla", value: 110, type: "interregional", product: "Manufacturas" },
                { source: "Bogotá", target: "Bucaramanga", value: 90, type: "interregional", product: "Flores" },
                { source: "Bogotá", target: "Villavicencio", value: 120, type: "local", product: "Arroz" },
                { source: "Medellín", target: "Cali", value: 200, type: "exportacion", product: "Banano" },
                { source: "Medellín", target: "Bucaramanga", value: 70, type: "interregional", product: "Caña" },
                { source: "Medellín", target: "Pereira", value: 65, type: "local", product: "Café" },
                { source: "Medellín", target: "Manizales", value: 85, type: "local", product: "Textiles" },
                { source: "Cali", target: "Barranquilla", value: 180, type: "interregional", product: "Arroz" },
                { source: "Cali", target: "Ibague", value: 95, type: "local", product: "Azúcar" },
                { source: "Barranquilla", target: "Cartagena", value: 120, type: "local", product: "Pescado" },
                { source: "Cartagena", target: "Santa Marta", value: 80, type: "local", product: "Turismo" },
                { source: "Cúcuta", target: "Bucaramanga", value: 75, type: "interregional", product: "Cacao" },
                { source: "Pereira", target: "Manizales", value: 60, type: "local", product: "Café Especial" },
                { source: "Ibague", target: "Villavicencio", value: 55, type: "local", product: "Ganado" },
                { source: "Santa Marta", target: "Barranquilla", value: 45, type: "local", product: "Pescado" }
            ]
        };

        // Variables globales
        let map, simulation, svg;
        let nodeGroup, linkGroup;
        let cityMarkers = {};
        let selectedMunicipio = null;
        let currentFilter = null;

        // Escalas de color
        const nodeColorScale = d3.scaleSequential(d3.interpolateBlues)
            .domain([0, 800]);

        const linkColorScale = d3.scaleSequential(d3.interpolateMagma)
            .domain([50, 200]);

        // Calcular volúmenes recibidos y tipos de conexión
        function calculateReceivedVolumes() {
            graphData.nodes.forEach(node => {
                node.receivedVolume = graphData.links
                    .filter(link => link.target.id === node.id || link.target === node.id)
                    .reduce((sum, link) => sum + link.value, 0);
                
                node.connectionCount = graphData.links.filter(link => 
                    link.source.id === node.id || link.target.id === node.id
                ).length;
                
                if (node.connectionCount >= 4) {
                    node.connectionType = 'hub';
                } else if (node.connectionCount >= 2) {
                    node.connectionType = 'multiple';
                } else {
                    node.connectionType = 'single';
                }
            });
        }

        // Inicializar la aplicación
        function initApplication() {
            console.log("Iniciando aplicación...");
            calculateReceivedVolumes();
            initMap();
            initGraph();
            generateMunicipioSelect();
            updateMetrics();
            updateFilterStatus();
            
            document.getElementById('map-debug').textContent = 'Mapa: Listo - ' + graphData.nodes.length + ' municipios cargados';
            document.getElementById('graph-debug').textContent = 'Grafo: Listo - ' + graphData.links.length + ' conexiones';
        }

        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([4.5709, -74.2973], 6);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '©OpenStreetMap, ©CartoDB'
            }).addTo(map);

            addCityMarkers();
        }

        // Agregar marcadores al mapa
        function addCityMarkers() {
            Object.keys(citiesData).forEach(city => {
                const data = citiesData[city];
                const nodeData = graphData.nodes.find(n => n.id === city);
                
                const marker = L.circleMarker([data.lat, data.lng], {
                    radius: 8,
                    fillColor: '#2c5aa0',
                    color: '#fff',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.7,
                    className: 'city-marker'
                }).addTo(map);

                marker.bindPopup(`
                    <div style="color: #333; min-width: 200px;">
                        <strong>${city}</strong><br>
                        Región: ${data.region}<br>
                        Población: ${data.population.toLocaleString()}<br>
                        Volumen Recibido: ${nodeData.receivedVolume}t<br>
                        Conexiones: ${nodeData.connectionCount}
                    </div>
                `);

                cityMarkers[city] = marker;
            });
        }

        // Inicializar grafo
        function initGraph() {
            const graphElement = document.getElementById('graph');
            const width = graphElement.clientWidth;
            const height = graphElement.clientHeight;

            svg = d3.select('#graph')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            linkGroup = svg.append('g').attr('class', 'links');
            nodeGroup = svg.append('g').attr('class', 'nodes');

            initSimulation();
            updateVisualization();
        }

        function initSimulation() {
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(150))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(getGraphCenter().x, getGraphCenter().y))
                .force('collision', d3.forceCollide().radius(40));

            simulation.on('tick', () => {
                updateGraphPositions();
            });
        }

        // ACTUALIZAR VISUALIZACIÓN - FUNCIÓN PRINCIPAL
        function updateVisualization() {
            updateGraph();
            updateMap();
            updateFilterStatus();
            updateSelectionInfo();
        }

        function updateGraph() {
            // Determinar qué elementos mostrar basado en el filtro
            let nodesToShow = graphData.nodes;
            let linksToShow = graphData.links;

            if (currentFilter) {
                const connectedNodes = new Set([currentFilter]);
                const connectedLinks = graphData.links.filter(link => 
                    link.source.id === currentFilter || link.target.id === currentFilter
                );

                connectedLinks.forEach(link => {
                    connectedNodes.add(link.source.id);
                    connectedNodes.add(link.target.id);
                });

                nodesToShow = graphData.nodes.filter(node => connectedNodes.has(node.id));
                linksToShow = connectedLinks;
            }

            // Actualizar links
            const links = linkGroup.selectAll('line')
                .data(linksToShow, d => `${d.source.id}-${d.target.id}`)
                .join('line')
                .attr('class', d => {
                    let className = 'graph-link';
                    if (currentFilter && (d.source.id === currentFilter || d.target.id === currentFilter)) {
                        className += ' highlighted';
                    }
                    if (!currentFilter || linksToShow.includes(d)) {
                        // Visible
                    } else {
                        className += ' hidden';
                    }
                    return className;
                })
                .attr('stroke', d => linkColorScale(d.value))
                .attr('stroke-width', d => Math.max(2, d.value / 20))
                .attr('opacity', d => {
                    if (currentFilter && (d.source.id === currentFilter || d.target.id === currentFilter)) {
                        return 1;
                    }
                    return currentFilter ? 0.3 : 0.7;
                })
                .style('pointer-events', 'none');

            // Actualizar nodes
            const nodes = nodeGroup.selectAll('circle')
                .data(nodesToShow, d => d.id)
                .join('circle')
                .attr('class', d => {
                    let className = 'graph-node';
                    if (d.id === currentFilter) {
                        className += ' highlighted';
                    } else if (currentFilter && nodesToShow.includes(d)) {
                        className += ' connected';
                    }
                    if (!currentFilter || nodesToShow.includes(d)) {
                        // Visible
                    } else {
                        className += ' hidden';
                    }
                    return className;
                })
                .attr('r', d => 12 + (d.receivedVolume / 40))
                .attr('fill', d => nodeColorScale(d.receivedVolume))
                .attr('stroke', d => d3.color(nodeColorScale(d.receivedVolume)).brighter(0.8))
                .attr('stroke-width', 2)
                .style('pointer-events', 'none');

            // Etiquetas de nodos
            const labels = nodeGroup.selectAll('text')
                .data(nodesToShow, d => d.id)
                .join('text')
                .text(d => d.id)
                .attr('text-anchor', 'middle')
                .attr('dy', d => -15 - (d.receivedVolume / 40))
                .attr('fill', '#2c5aa0')
                .attr('font-size', '10px')
                .style('font-weight', 'bold')
                .style('text-shadow', '1px 1px 2px rgba(255,255,255,0.8)')
                .style('pointer-events', 'none');

            // Actualizar simulación
            simulation.nodes(nodesToShow);
            simulation.force('link').links(linksToShow);
            simulation.alpha(0.3).restart();
        }

        function updateGraphPositions() {
            linkGroup.selectAll('line')
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            nodeGroup.selectAll('circle')
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);

            nodeGroup.selectAll('text')
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        }

        function updateMap() {
            // Resetear todos los marcadores
            Object.values(cityMarkers).forEach(marker => {
                marker.setStyle({
                    fillColor: '#2c5aa0',
                    color: '#fff',
                    radius: 8,
                    fillOpacity: 0.7,
                    opacity: 0.8
                });
                marker.removeClassName('highlighted');
                marker.removeClassName('connected');
                marker.removeClassName('hidden');
            });

            if (currentFilter) {
                // Resaltar municipio del filtro
                if (cityMarkers[currentFilter]) {
                    cityMarkers[currentFilter].setStyle({
                        fillColor: '#ff6b6b',
                        color: '#fff',
                        radius: 12,
                        fillOpacity: 0.9,
                        opacity: 1
                    });
                    cityMarkers[currentFilter].addClassName('highlighted');
                }

                // Resaltar municipios conectados
                const connectedLinks = graphData.links.filter(link => 
                    link.source.id === currentFilter || link.target.id === currentFilter
                );

                const connectedCities = new Set();
                connectedLinks.forEach(link => {
                    connectedCities.add(link.source.id);
                    connectedCities.add(link.target.id);
                });

                connectedCities.forEach(city => {
                    if (city !== currentFilter && cityMarkers[city]) {
                        cityMarkers[city].setStyle({
                            fillColor: '#64b5f6',
                            color: '#fff',
                            radius: 10,
                            fillOpacity: 0.8,
                            opacity: 0.9
                        });
                        cityMarkers[city].addClassName('connected');
                    }
                });

                // Atenuar municipios no conectados
                graphData.nodes.forEach(node => {
                    if (!connectedCities.has(node.id) && cityMarkers[node.id]) {
                        cityMarkers[node.id].setStyle({
                            fillOpacity: 0.3,
                            opacity: 0.4
                        });
                        cityMarkers[node.id].addClassName('hidden');
                    }
                });

                // Centrar en el municipio del filtro
                const cityData = citiesData[currentFilter];
                if (cityData) {
                    map.setView([cityData.lat, cityData.lng], 7);
                }
            }
        }

        function getGraphCenter() {
            const graphElement = document.getElementById('graph');
            return { 
                x: graphElement.clientWidth / 2, 
                y: graphElement.clientHeight / 2 
            };
        }

        // GENERAR SELECT DESPLEGABLE - CORREGIDO
        function generateMunicipioSelect() {
            console.log("Generando select desplegable...");
            const selectElement = document.getElementById('municipio-select');
            
            // Limpiar opciones existentes (excepto la primera)
            while (selectElement.children.length > 1) {
                selectElement.removeChild(selectElement.lastChild);
            }

            // Ordenar por número de conexiones (de mayor a menor)
            const sortedNodes = [...graphData.nodes].sort((a, b) => b.connectionCount - a.connectionCount);
            console.log("Nodos ordenados:", sortedNodes);

            // Agregar opciones al select
            sortedNodes.forEach(node => {
                const option = document.createElement('option');
                option.value = node.id;
                
                let emoji = '';
                if (node.connectionType === 'hub') {
                    emoji = '🏙️ ';
                } else if (node.connectionType === 'multiple') {
                    emoji = '🏘️ ';
                } else {
                    emoji = '📍 ';
                }
                
                option.textContent = `${emoji}${node.id} (${node.connectionCount} conexiones, ${node.receivedVolume}t)`;
                selectElement.appendChild(option);
            });

            console.log("Select generado con", sortedNodes.length, "opciones");
        }

        // Cuando se selecciona un municipio del dropdown
        function onMunicipioSelect(value) {
            console.log("Municipio seleccionado:", value);
            selectedMunicipio = value;
            updateSelectedInfo();
        }

        // Actualizar información del municipio seleccionado
        function updateSelectedInfo() {
            const infoDiv = document.getElementById('selected-info');
            const nameDiv = document.getElementById('selected-name');
            const detailsDiv = document.getElementById('selected-details');

            if (!selectedMunicipio) {
                infoDiv.style.display = 'none';
                return;
            }

            const node = graphData.nodes.find(n => n.id === selectedMunicipio);
            if (!node) return;

            nameDiv.textContent = node.id;
            
            let typeText = '';
            if (node.connectionType === 'hub') {
                typeText = '<span class="type-indicator type-hub">Centro de red</span>';
            } else if (node.connectionType === 'multiple') {
                typeText = '<span class="type-indicator type-multiple">Múltiples conexiones</span>';
            } else {
                typeText = '<span class="type-indicator type-single">Una conexión</span>';
            }

            detailsDiv.innerHTML = `
                ${typeText}
                <span class="connection-badge">${node.connectionCount} conexiones</span><br>
                Volumen recibido: ${node.receivedVolume}t<br>
                Población: ${node.population.toLocaleString()}<br>
                Región: ${node.region}
            `;

            infoDiv.style.display = 'block';
        }

        // Aplicar filtro
        function applyFilter() {
            console.log("Aplicando filtro para:", selectedMunicipio);
            if (selectedMunicipio) {
                currentFilter = selectedMunicipio;
                updateVisualization();
                document.getElementById('graph-debug').textContent = `Filtro aplicado: ${selectedMunicipio}`;
            } else {
                alert('Por favor selecciona un municipio primero');
            }
        }

        // Limpiar filtro
        function clearFilter() {
            console.log("Limpiando filtro");
            currentFilter = null;
            selectedMunicipio = null;
            document.getElementById('municipio-select').value = '';
            document.getElementById('selected-info').style.display = 'none';
            updateVisualization();
            document.getElementById('graph-debug').textContent = 'Filtro limpiado - Mostrando toda la red';
        }

        function updateFilterStatus() {
            const statusElement = document.getElementById('filter-status');
            if (currentFilter) {
                statusElement.textContent = `Filtro activo: ${currentFilter} - Mostrando conexiones directas`;
                statusElement.classList.add('active');
            } else {
                statusElement.textContent = 'Sin filtro activo - Mostrando toda la red';
                statusElement.classList.remove('active');
            }
        }

        function updateSelectionInfo() {
            const infoDiv = document.getElementById('selection-info');
            const detailsDiv = document.getElementById('selection-details');

            if (!currentFilter) {
                infoDiv.style.display = 'none';
                return;
            }

            const node = graphData.nodes.find(n => n.id === currentFilter);
            const connections = graphData.links.filter(link => 
                link.source.id === currentFilter || link.target.id === currentFilter
            );

            const exportVolume = connections.filter(link => link.source.id === currentFilter)
                .reduce((sum, link) => sum + link.value, 0);
            const importVolume = connections.filter(link => link.target.id === currentFilter)
                .reduce((sum, link) => sum + link.value, 0);

            const connectedCities = [...new Set(connections.flatMap(link => 
                [link.source.id, link.target.id].filter(id => id !== currentFilter)
            ))];

            detailsDiv.innerHTML = `
                <strong>${currentFilter}</strong><br>
                Conexiones activas: ${connections.length}<br>
                Exporta: ${exportVolume}t<br>
                Importa: ${importVolume}t<br>
                Municipios conectados: ${connectedCities.join(', ')}
            `;

            infoDiv.style.display = 'block';
        }

        // Funciones de control
        function simulatePhysics() {
            simulation.alphaTarget(0.1).restart();
            setTimeout(() => simulation.alphaTarget(0), 2000);
        }

        function resetGraphLayout() {
            graphData.nodes.forEach(node => {
                node.fx = null;
                node.fy = null;
                node.x = Math.random() * 500 + 200;
                node.y = Math.random() * 300 + 150;
            });
            simulation.alpha(1).restart();
        }

        function fitMapToCities() {
            const bounds = new L.LatLngBounds();
            Object.values(citiesData).forEach(city => {
                bounds.extend([city.lat, city.lng]);
            });
            map.fitBounds(bounds, { padding: [30, 30] });
        }

        function updateMetrics() {
            const totalToneladas = graphData.links.reduce((sum, link) => sum + link.value, 0);
            const promedio = totalToneladas / graphData.links.length;

            document.getElementById('total-toneladas').textContent = totalToneladas;
            document.getElementById('total-conexiones').textContent = graphData.links.length;
            document.getElementById('total-municipios').textContent = graphData.nodes.length;
            document.getElementById('flujo-promedio').textContent = promedio.toFixed(1);
        }

        // Inicializar aplicación
        window.addEventListener('load', initApplication);

        // Redimensionar
        window.addEventListener('resize', function() {
            const graphElement = document.getElementById('graph');
            const width = graphElement.clientWidth;
            const height = graphElement.clientHeight;
            
            d3.select('#graph svg')
                .attr('width', width)
                .attr('height', height);
                
            simulation.force('center', d3.forceCenter(width / 2, height / 2));
            simulation.alpha(0.3).restart();
        });

        // Hacer funciones globales
        window.onMunicipioSelect = onMunicipioSelect;
        window.applyFilter = applyFilter;
        window.clearFilter = clearFilter;
        window.simulatePhysics = simulatePhysics;
        window.resetGraphLayout = resetGraphLayout;
        window.fitMapToCities = fitMapToCities;

        // Función de debug para verificar que los datos están cargados
        window.debugData = function() {
            console.log("Graph nodes:", graphData.nodes);
            console.log("Graph links:", graphData.links);
            console.log("Select element:", document.getElementById('municipio-select'));
        }
    </script>
</body>
</html>
